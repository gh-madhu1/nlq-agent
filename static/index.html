<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NL2SQL Agent</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <style>
        *,
        *::before,
        *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        :root {
            --bg-primary: #0a0e17;
            --bg-secondary: #111827;
            --bg-card: #1a2235;
            --bg-card-hover: #1e2943;
            --border: #2a3654;
            --border-glow: #3b82f6;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --accent-blue: #3b82f6;
            --accent-cyan: #06b6d4;
            --accent-green: #10b981;
            --accent-amber: #f59e0b;
            --accent-red: #ef4444;
            --accent-purple: #8b5cf6;
            --gradient-primary: linear-gradient(135deg, #3b82f6, #06b6d4);
            --gradient-surface: linear-gradient(135deg, rgba(59, 130, 246, 0.08), rgba(6, 182, 212, 0.05));
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                radial-gradient(ellipse 80% 50% at 50% -20%, rgba(59, 130, 246, 0.12), transparent),
                radial-gradient(ellipse 60% 40% at 80% 50%, rgba(6, 182, 212, 0.06), transparent),
                radial-gradient(ellipse 60% 40% at 20% 80%, rgba(139, 92, 246, 0.06), transparent);
            pointer-events: none;
            z-index: 0;
        }

        .app {
            position: relative;
            z-index: 1;
            max-width: 920px;
            margin: 0 auto;
            padding: 2rem 1.5rem;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 2.5rem;
        }

        .header h1 {
            font-size: 2.2rem;
            font-weight: 700;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
            letter-spacing: -0.03em;
        }

        .header p {
            color: var(--text-secondary);
            font-size: 1rem;
        }

        /* Query input */
        .query-box {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 1.25rem;
            margin-bottom: 2rem;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        .query-box:focus-within {
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15), 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .input-row {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }

        .query-input {
            flex: 1;
            background: transparent;
            border: none;
            outline: none;
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            font-size: 1.05rem;
            padding: 0.5rem 0.25rem;
        }

        .query-input::placeholder {
            color: var(--text-muted);
        }

        .send-btn {
            background: var(--gradient-primary);
            border: none;
            border-radius: 12px;
            color: white;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            font-size: 0.9rem;
            padding: 0.65rem 1.5rem;
            cursor: pointer;
            transition: transform 0.15s, box-shadow 0.3s, opacity 0.3s;
            white-space: nowrap;
        }

        .send-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.35);
        }

        .send-btn:active {
            transform: translateY(0);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .examples {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        .example-chip {
            background: rgba(59, 130, 246, 0.08);
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 20px;
            padding: 0.35rem 0.85rem;
            font-size: 0.8rem;
            color: var(--accent-cyan);
            cursor: pointer;
            transition: all 0.2s;
        }

        .example-chip:hover {
            background: rgba(59, 130, 246, 0.15);
            border-color: var(--accent-blue);
        }

        /* Pipeline steps */
        .pipeline {
            display: flex;
            flex-direction: column;
            gap: 0;
        }

        .step {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem 1.25rem;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: flex-start;
            gap: 0.85rem;
            opacity: 0;
            transform: translateY(12px);
            animation: slideIn 0.35s ease forwards;
            transition: border-color 0.3s;
        }

        @keyframes slideIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .step.active {
            border-color: var(--accent-blue);
        }

        .step.success {
            border-color: var(--accent-green);
        }

        .step.error {
            border-color: var(--accent-red);
        }

        .step-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .step-body {
            flex: 1;
            min-width: 0;
        }

        .step-label {
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.04em;
            margin-bottom: 0.3rem;
        }

        .step-content {
            font-size: 0.92rem;
            color: var(--text-primary);
            line-height: 1.55;
            word-break: break-word;
        }

        /* Icon backgrounds */
        .icon-start {
            background: rgba(59, 130, 246, 0.15);
            color: var(--accent-blue);
        }

        .icon-intent {
            background: rgba(139, 92, 246, 0.15);
            color: var(--accent-purple);
        }

        .icon-schema {
            background: rgba(6, 182, 212, 0.15);
            color: var(--accent-cyan);
        }

        .icon-plan {
            background: rgba(245, 158, 11, 0.15);
            color: var(--accent-amber);
        }

        .icon-sql {
            background: rgba(16, 185, 129, 0.15);
            color: var(--accent-green);
        }

        .icon-valid {
            background: rgba(16, 185, 129, 0.15);
            color: var(--accent-green);
        }

        .icon-exec {
            background: rgba(59, 130, 246, 0.15);
            color: var(--accent-blue);
        }

        .icon-answer {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(6, 182, 212, 0.2));
            color: var(--accent-cyan);
        }

        .icon-error {
            background: rgba(239, 68, 68, 0.15);
            color: var(--accent-red);
        }

        /* SQL code block */
        .sql-block {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.82rem;
            background: rgba(0, 0, 0, 0.35);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            margin-top: 0.4rem;
            overflow-x: auto;
            color: var(--accent-cyan);
            white-space: pre-wrap;
            position: relative;
        }

        .sql-block .sql-keyword {
            color: #c084fc;
            font-weight: 500;
        }

        .sql-block .sql-string {
            color: #34d399;
        }

        .sql-block .sql-number {
            color: #fbbf24;
        }

        .sql-block .sql-func {
            color: #60a5fa;
        }

        /* Result table */
        .result-table-wrap {
            margin-top: 0.5rem;
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .result-table {
            width: 100%;
            border-collapse: collapse;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
        }

        .result-table thead {
            background: rgba(59, 130, 246, 0.1);
        }

        .result-table th {
            padding: 0.55rem 0.85rem;
            text-align: left;
            font-weight: 600;
            color: var(--accent-cyan);
            border-bottom: 1px solid var(--border);
            white-space: nowrap;
            font-size: 0.78rem;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }

        .result-table td {
            padding: 0.5rem 0.85rem;
            border-bottom: 1px solid rgba(42, 54, 84, 0.5);
            color: var(--text-primary);
            white-space: nowrap;
        }

        .result-table tbody tr {
            transition: background 0.15s;
        }

        .result-table tbody tr:hover {
            background: rgba(59, 130, 246, 0.06);
        }

        .result-table tbody tr:last-child td {
            border-bottom: none;
        }

        .result-table .cell-number {
            color: var(--accent-amber);
            text-align: right;
        }

        .result-table .cell-null {
            color: var(--text-muted);
            font-style: italic;
        }

        .result-meta {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.35rem;
            font-size: 0.78rem;
            color: var(--text-muted);
        }

        .result-badge {
            background: rgba(59, 130, 246, 0.12);
            color: var(--accent-blue);
            padding: 0.15rem 0.55rem;
            border-radius: 10px;
            font-weight: 500;
            font-size: 0.72rem;
        }

        /* Schema tags */
        .schema-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.4rem;
            margin-top: 0.25rem;
        }

        .schema-tag {
            background: rgba(6, 182, 212, 0.1);
            border: 1px solid rgba(6, 182, 212, 0.25);
            border-radius: 6px;
            padding: 0.25rem 0.6rem;
            font-size: 0.78rem;
            color: var(--accent-cyan);
            font-family: 'JetBrains Mono', monospace;
        }

        .schema-tag .tag-table {
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Plan list */
        .plan-list {
            margin: 0.25rem 0 0 0;
            padding: 0;
            list-style: none;
        }

        .plan-list li {
            position: relative;
            padding: 0.3rem 0 0.3rem 1.3rem;
            font-size: 0.88rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .plan-list li::before {
            content: '‚Üí';
            position: absolute;
            left: 0;
            color: var(--accent-amber);
            font-weight: 600;
        }

        /* Final answer card */
        .final-answer {
            background: var(--gradient-surface);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 16px;
            padding: 1.5rem;
            margin-top: 0.5rem;
            opacity: 0;
            animation: slideIn 0.5s ease forwards;
        }

        .final-answer .step-content {
            font-size: 1.05rem;
            line-height: 1.75;
        }

        .final-answer .answer-text p {
            margin-bottom: 0.5rem;
        }

        .final-answer .answer-text strong {
            color: var(--accent-cyan);
        }

        .final-answer .answer-text code {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            background: rgba(0, 0, 0, 0.3);
            padding: 0.15rem 0.4rem;
            border-radius: 4px;
            color: var(--accent-amber);
        }

        /* Intent badges */
        .intent-badges {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .intent-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.3rem 0.7rem;
            border-radius: 8px;
            font-size: 0.82rem;
            font-weight: 500;
        }

        .intent-badge.data-yes {
            background: rgba(59, 130, 246, 0.12);
            color: var(--accent-blue);
        }

        .intent-badge.data-no {
            background: rgba(139, 92, 246, 0.12);
            color: var(--accent-purple);
        }

        .intent-badge.safe {
            background: rgba(16, 185, 129, 0.12);
            color: var(--accent-green);
        }

        .intent-badge.unsafe {
            background: rgba(239, 68, 68, 0.12);
            color: var(--accent-red);
        }

        /* Spinner */
        .spinner {
            width: 18px;
            height: 18px;
            border: 2px solid rgba(59, 130, 246, 0.2);
            border-top-color: var(--accent-blue);
            border-radius: 50%;
            animation: spin 0.7s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-left: 0.4rem;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-muted);
        }

        .empty-state .icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-state p {
            font-size: 0.95rem;
        }

        /* Responsive */
        @media (max-width: 640px) {
            .app {
                padding: 1.25rem 1rem;
            }

            .header h1 {
                font-size: 1.6rem;
            }

            .examples {
                gap: 0.4rem;
            }

            .example-chip {
                font-size: 0.75rem;
                padding: 0.3rem 0.7rem;
            }

            .result-table th,
            .result-table td {
                padding: 0.4rem 0.5rem;
                font-size: 0.72rem;
            }
        }
    </style>
</head>

<body>
    <div class="app">
        <div class="header">
            <h1>‚ö° NL2SQL Agent</h1>
            <p>Ask questions about your data in plain English</p>
        </div>

        <div class="query-box">
            <div class="input-row">
                <input type="text" class="query-input" id="queryInput" placeholder="e.g. How many users are there?"
                    autofocus autocomplete="off">
                <button class="send-btn" id="sendBtn" onclick="submitQuery()">
                    Run Query
                </button>
            </div>
            <div class="examples">
                <span class="example-chip" onclick="setQuery(this)">How many users are there?</span>
                <span class="example-chip" onclick="setQuery(this)">List all products under $100</span>
                <span class="example-chip" onclick="setQuery(this)">What is the total of order 1?</span>
                <span class="example-chip" onclick="setQuery(this)">Show Alice's email</span>
            </div>
        </div>

        <div id="pipeline" class="pipeline">
            <div class="empty-state" id="emptyState">
                <div class="icon">üóÑÔ∏è</div>
                <p>Enter a question to query your database</p>
            </div>
        </div>
    </div>

    <script>
        const STEP_META = {
            start: { icon: 'üöÄ', label: 'Query Received', cls: 'icon-start' },
            intent_classification: { icon: 'üîç', label: 'Intent & Safety', cls: 'icon-intent' },
            query_rewritten: { icon: '‚úèÔ∏è', label: 'Query Rewritten', cls: 'icon-rewrite' },
            planning_start: { icon: 'üìã', label: 'Planning Query', cls: 'icon-plan' },
            plan_created: { icon: '‚úÖ', label: 'Plan Created', cls: 'icon-plan-done' },
            schema_retrieval: { icon: 'üóÇÔ∏è', label: 'Schema Retrieval', cls: 'icon-schema' },
            sql_generation_start: { icon: '‚è≥', label: 'Generating SQL', cls: 'icon-sql' },
            sql_generated: { icon: 'üíæ', label: 'Generated SQL', cls: 'icon-sql' },
            syntax_validation_passed: { icon: '‚úÖ', label: 'Syntax Valid', cls: 'icon-valid' },
            syntax_validation_failed: { icon: '‚ùå', label: 'Syntax Error', cls: 'icon-error' },
            semantic_validation_passed: { icon: 'üîç', label: 'Semantic Valid', cls: 'icon-verify' },
            semantic_validation_failed: { icon: '‚ö†Ô∏è', label: 'Semantic Error', cls: 'icon-verify-fail' },
            validation_passed: { icon: '‚úÖ', label: 'All Validations Passed', cls: 'icon-valid' },
            validation_failed: { icon: '‚ö†Ô∏è', label: 'Validation Failed', cls: 'icon-error' },
            execution_success: { icon: 'üìä', label: 'Query Results', cls: 'icon-exec' },
            execution_failed: { icon: '‚ùå', label: 'Execution Failed', cls: 'icon-error' },
            formatting: { icon: 'üìù', label: 'Formatting Answer', cls: 'icon-format' },
            final_answer: { icon: '‚ú®', label: 'Answer Ready', cls: 'icon-answer' },
            error: { icon: 'üö´', label: 'Error', cls: 'icon-error' }
        };

        const SQL_KEYWORDS = [
            'SELECT', 'FROM', 'WHERE', 'JOIN', 'LEFT', 'RIGHT', 'INNER', 'OUTER', 'ON',
            'GROUP BY', 'ORDER BY', 'HAVING', 'LIMIT', 'AS', 'AND', 'OR', 'NOT', 'IN',
            'BETWEEN', 'LIKE', 'IS', 'NULL', 'COUNT', 'SUM', 'AVG', 'MAX', 'MIN',
            'DISTINCT', 'UNION', 'INSERT', 'UPDATE', 'DELETE', 'CREATE', 'ALTER', 'DROP',
            'ASC', 'DESC', 'CASE', 'WHEN', 'THEN', 'ELSE', 'END', 'CAST', 'COALESCE'
        ];

        const inputEl = document.getElementById('queryInput');
        const btn = document.getElementById('sendBtn');
        const pipeline = document.getElementById('pipeline');

        inputEl.addEventListener('keydown', e => { if (e.key === 'Enter' && !btn.disabled) submitQuery(); });

        function setQuery(el) { inputEl.value = el.textContent; inputEl.focus(); }

        function escapeHtml(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        /* ---------- SQL syntax highlighting ---------- */
        function highlightSQL(sql) {
            let escaped = escapeHtml(sql);
            // Strings
            escaped = escaped.replace(/('(?:[^'\\]|\\.)*')/g, '<span class="sql-string">$1</span>');
            // Numbers
            escaped = escaped.replace(/\b(\d+(?:\.\d+)?)\b/g, '<span class="sql-number">$1</span>');
            // Keywords (longest first to avoid partial matches)
            const sorted = SQL_KEYWORDS.slice().sort((a, b) => b.length - a.length);
            sorted.forEach(kw => {
                const re = new RegExp('\\b(' + kw.replace(/ /g, '\\s+') + ')\\b', 'gi');
                escaped = escaped.replace(re, '<span class="sql-keyword">$1</span>');
            });
            // Functions
            escaped = escaped.replace(/\b([a-zA-Z_]\w*)\s*(?=\()/g, (m, fn) => {
                if (SQL_KEYWORDS.includes(fn.toUpperCase())) return m;
                return `<span class="sql-func">${fn}</span>`;
            });
            return escaped;
        }

        /* ---------- Data result table ---------- */
        function buildResultTable(data) {
            if (!Array.isArray(data) || data.length === 0) {
                return '<span style="color:var(--text-muted)">No rows returned</span>';
            }
            const keys = Object.keys(data[0]);
            const showRows = data.slice(0, 20);
            const truncated = data.length > 20;

            let html = '<div class="result-table-wrap"><table class="result-table"><thead><tr>';
            keys.forEach(k => { html += `<th>${escapeHtml(k)}</th>`; });
            html += '</tr></thead><tbody>';

            showRows.forEach(row => {
                html += '<tr>';
                keys.forEach(k => {
                    const val = row[k];
                    if (val === null || val === undefined) {
                        html += '<td class="cell-null">NULL</td>';
                    } else if (typeof val === 'number') {
                        html += `<td class="cell-number">${formatNumber(val)}</td>`;
                    } else {
                        html += `<td>${escapeHtml(String(val))}</td>`;
                    }
                });
                html += '</tr>';
            });
            html += '</tbody></table></div>';

            html += '<div class="result-meta">';
            html += `<span class="result-badge">${data.length} row${data.length !== 1 ? 's' : ''}</span>`;
            html += `<span>${keys.length} column${keys.length !== 1 ? 's' : ''}</span>`;
            if (truncated) html += `<span>¬∑ showing first 20 of ${data.length}</span>`;
            html += '</div>';
            return html;
        }

        function formatNumber(n) {
            if (Number.isInteger(n)) return n.toLocaleString();
            return n.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        /* ---------- Schema context ---------- */
        function buildSchemaContext(data) {
            if (typeof data === 'string') {
                // Parse "Table: x\nColumns: a, b" blocks
                const blocks = data.split(/\n\n+/);
                let html = '<div class="schema-tags">';
                blocks.forEach(block => {
                    const tableMatch = block.match(/Table:\s*(\w+)/i);
                    const colMatch = block.match(/Columns?:\s*(.+)/i);
                    if (tableMatch) {
                        const tbl = tableMatch[1];
                        const cols = colMatch ? colMatch[1].split(',').map(c => c.trim()) : [];
                        html += `<div class="schema-tag"><span class="tag-table">${escapeHtml(tbl)}</span>`;
                        if (cols.length) html += ` (${cols.map(c => escapeHtml(c)).join(', ')})`;
                        html += '</div>';
                    }
                });
                html += '</div>';
                return html;
            }
            return `<div class="sql-block">${escapeHtml(JSON.stringify(data, null, 2))}</div>`;
        }

        /* ---------- Plan formatting ---------- */
        function buildPlan(data) {
            const text = typeof data === 'string' ? data : JSON.stringify(data);
            // Split by newlines, bullets, or numbered items
            const lines = text.split(/\n/).map(l => l.replace(/^[\s\-\*\d.]+/, '').trim()).filter(Boolean);
            if (lines.length <= 1) return `<span style="color:var(--text-secondary)">${escapeHtml(text)}</span>`;
            let html = '<ul class="plan-list">';
            lines.forEach(l => { html += `<li>${escapeHtml(l)}</li>`; });
            html += '</ul>';
            return html;
        }

        /* ---------- Final answer formatting ---------- */
        function formatAnswer(data) {
            let text = typeof data === 'string' ? data : JSON.stringify(data);
            return `<div class="answer-text">${renderMarkdown(text)}</div>`;
        }

        /* ---------- Lightweight Markdown ‚Üí HTML ---------- */
        function renderMarkdown(md) {
            const lines = md.split('\n');
            let html = '';
            let inTable = false;
            let inList = false;
            let listType = '';  // 'ul' or 'ol'

            for (let i = 0; i < lines.length; i++) {
                let line = lines[i];

                // --- Markdown table ---
                if (/^\s*\|/.test(line)) {
                    const cells = line.split('|').slice(1, -1).map(c => c.trim());
                    if (!inTable) {
                        inTable = true;
                        html += '<div class="result-table-wrap"><table class="result-table"><thead><tr>';
                        cells.forEach(c => { html += `<th>${inlineMarkdown(c)}</th>`; });
                        html += '</tr></thead><tbody>';
                        // Skip separator row (|---|---|)
                        if (i + 1 < lines.length && /^\s*\|[\s\-:|]+\|/.test(lines[i + 1])) i++;
                    } else {
                        html += '<tr>';
                        cells.forEach(c => {
                            const isNum = /^\$?[\d,.]+%?$/.test(c.trim());
                            html += `<td${isNum ? ' class="cell-number"' : ''}>${inlineMarkdown(c)}</td>`;
                        });
                        html += '</tr>';
                    }
                    continue;
                } else if (inTable) {
                    html += '</tbody></table></div>';
                    inTable = false;
                }

                // --- Close list if line is not a list item ---
                const isBullet = /^\s*[-*]\s+(.+)/.test(line);
                const isOrdered = /^\s*\d+\.\s+(.+)/.test(line);
                if (inList && !isBullet && !isOrdered) {
                    html += `</${listType}>`;
                    inList = false;
                }

                // --- Headers ---
                const h3 = line.match(/^###\s+(.+)/);
                if (h3) { html += `<h4 style="color:var(--accent-cyan);margin:0.6rem 0 0.2rem;font-size:0.9rem">${inlineMarkdown(h3[1])}</h4>`; continue; }
                const h2 = line.match(/^##\s+(.+)/);
                if (h2) { html += `<h3 style="color:var(--accent-cyan);margin:0.8rem 0 0.3rem;font-size:1rem">${inlineMarkdown(h2[1])}</h3>`; continue; }
                const h1 = line.match(/^#\s+(.+)/);
                if (h1) { html += `<h3 style="color:var(--text-primary);margin:0.8rem 0 0.3rem;font-size:1.05rem">${inlineMarkdown(h1[1])}</h3>`; continue; }

                // --- Bullet list ---
                if (isBullet) {
                    const content = line.match(/^\s*[-*]\s+(.+)/)[1];
                    if (!inList || listType !== 'ul') {
                        if (inList) html += `</${listType}>`;
                        html += '<ul style="margin:0.3rem 0;padding-left:1.3rem">';
                        inList = true; listType = 'ul';
                    }
                    html += `<li style="margin:0.15rem 0;color:var(--text-secondary)">${inlineMarkdown(content)}</li>`;
                    continue;
                }

                // --- Ordered list ---
                if (isOrdered) {
                    const content = line.match(/^\s*\d+\.\s+(.+)/)[1];
                    if (!inList || listType !== 'ol') {
                        if (inList) html += `</${listType}>`;
                        html += '<ol style="margin:0.3rem 0;padding-left:1.3rem">';
                        inList = true; listType = 'ol';
                    }
                    html += `<li style="margin:0.15rem 0;color:var(--text-secondary)">${inlineMarkdown(content)}</li>`;
                    continue;
                }

                // --- Blank line = paragraph break ---
                if (line.trim() === '') { html += '<div style="height:0.4rem"></div>'; continue; }

                // --- Normal paragraph ---
                html += `<p style="margin:0.2rem 0">${inlineMarkdown(line)}</p>`;
            }

            if (inTable) html += '</tbody></table></div>';
            if (inList) html += `</${listType}>`;
            return html;
        }

        /* ---------- Inline markdown (bold, code, italic) ---------- */
        function inlineMarkdown(text) {
            let s = escapeHtml(text);
            s = s.replace(/\*\*(.+?)\*\*/g, '<strong style="color:var(--accent-cyan)">$1</strong>');
            s = s.replace(/`(.+?)`/g, '<code style="background:rgba(0,0,0,0.3);padding:0.1rem 0.35rem;border-radius:3px;color:var(--accent-amber);font-family:JetBrains Mono,monospace;font-size:0.82rem">$1</code>');
            s = s.replace(/\*(.+?)\*/g, '<em>$1</em>');
            return s;
        }

        /* ---------- Intent badges ---------- */
        function buildIntentBadges(data) {
            if (typeof data !== 'object') return escapeHtml(String(data));
            const isData = data.is_data_query;
            const isSafe = data.is_safe;
            return `<div class="intent-badges">
                <span class="intent-badge ${isData ? 'data-yes' : 'data-no'}">
                    ${isData ? 'üìä Data Query' : 'üí¨ General Chat'}
                </span>
                <span class="intent-badge ${isSafe ? 'safe' : 'unsafe'}">
                    ${isSafe ? '‚úÖ Safe' : 'üö´ Unsafe'}
                </span>
            </div>`;
        }

        /* ---------- Main content router ---------- */
        function formatContent(event, data) {
            switch (event) {
                case 'start':
                    return `<span style="color:var(--text-secondary)">"${escapeHtml(String(data))}"</span>`;

                case 'intent_classification':
                    return buildIntentBadges(data);

                case 'schema_retrieval':
                    return buildSchemaContext(data);

                case 'planning':
                    return buildPlan(data);

                case 'sql_generation_start':
                    return `Attempt ${data?.attempt || '?'} <span class="spinner"></span>`;

                case 'sql_generated':
                case 'validation_success':
                    return `<div class="sql-block">${highlightSQL(String(data))}</div>`;

                case 'execution_success':
                    return buildResultTable(data);

                case 'final_answer':
                    return formatAnswer(data);

                case 'validation_failed':
                case 'execution_failed':
                case 'error':
                    return `<span style="color:var(--accent-red)">${escapeHtml(String(data))}</span>`;

                default:
                    if (typeof data === 'object')
                        return `<div class="sql-block">${escapeHtml(JSON.stringify(data, null, 2))}</div>`;
                    return escapeHtml(String(data));
            }
        }

        /* ---------- Kill any active spinners from previous steps ---------- */
        function clearSpinners() {
            pipeline.querySelectorAll('.spinner').forEach(sp => {
                // Replace "Attempt N [spinner]" with "Attempt N ‚úì"
                const parent = sp.parentElement;
                sp.remove();
                if (parent) {
                    parent.innerHTML = parent.innerHTML.trimEnd() + ' <span style="color:var(--accent-green)">‚úì</span>';
                }
            });
        }

        /* ---------- Add step card ---------- */
        function addStep(event, data) {
            // Stop all spinners from previous steps before adding a new one
            clearSpinners();

            const meta = STEP_META[event] || { icon: '‚Ä¢', label: event, cls: 'icon-start' };
            const isFinal = event === 'final_answer';
            const isError = event === 'error' || event === 'validation_failed' || event === 'execution_failed';

            const el = document.createElement('div');
            el.className = isFinal ? 'final-answer' : 'step';
            if (isError) el.classList.add('error');
            else if (isFinal) el.classList.add('success');

            el.innerHTML = `
                <div class="step-icon ${meta.cls}">${meta.icon}</div>
                <div class="step-body">
                    <div class="step-label">${meta.label}</div>
                    <div class="step-content">${formatContent(event, data)}</div>
                </div>
            `;
            pipeline.appendChild(el);
            el.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        /* ---------- Submit query ---------- */
        function submitQuery() {
            const query = inputEl.value.trim();
            if (!query) return;

            pipeline.innerHTML = '';
            btn.disabled = true;
            btn.textContent = 'Running‚Ä¶';

            const source = new EventSource(`/stream?query=${encodeURIComponent(query)}`);

            source.onmessage = (e) => {
                try {
                    const payload = JSON.parse(e.data);
                    addStep(payload.event, payload.data);
                    if (payload.event === 'final_answer' || payload.event === 'error') {
                        source.close();
                        resetBtn();
                    }
                } catch (err) { console.error('Parse error:', err, e.data); }
            };

            source.onerror = () => {
                source.close();
                const steps = pipeline.children;
                const last = steps.length > 0 ? steps[steps.length - 1] : null;
                if (!last || !last.classList.contains('final-answer')) {
                    addStep('error', 'Connection lost. Is the server running?');
                }
                resetBtn();
            };
        }

        function resetBtn() { btn.disabled = false; btn.textContent = 'Run Query'; }
    </script>
</body>

</html>